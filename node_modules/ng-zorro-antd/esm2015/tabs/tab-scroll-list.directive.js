/**
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://github.com/NG-ZORRO/ng-zorro-antd/blob/master/LICENSE
 */
import { Directive, ElementRef, EventEmitter, NgZone, Output } from '@angular/core';
import { fromEvent, Subscription } from 'rxjs';
import * as ɵngcc0 from '@angular/core';
const MIN_SWIPE_DISTANCE = 0.1;
const STOP_SWIPE_DISTANCE = 0.01;
const REFRESH_INTERVAL = 20;
const SPEED_OFF_MULTIPLE = Math.pow(0.995, REFRESH_INTERVAL);
export class NzTabScrollListDirective {
    constructor(ngZone, elementRef) {
        this.ngZone = ngZone;
        this.elementRef = elementRef;
        this.lastWheelDirection = null;
        this.lastWheelTimestamp = 0;
        this.lastTimestamp = 0;
        this.lastTimeDiff = 0;
        this.lastMixedWheel = 0;
        this.lastWheelPrevent = false;
        this.touchPosition = null;
        this.lastOffset = null;
        this.motion = -1;
        this.unsubscribe = () => void 0;
        this.offsetChange = new EventEmitter();
        this.tabScroll = new EventEmitter();
        this.onTouchEnd = (e) => {
            if (!this.touchPosition) {
                return;
            }
            const lastOffset = this.lastOffset;
            const lastTimeDiff = this.lastTimeDiff;
            this.lastOffset = this.touchPosition = null;
            if (lastOffset) {
                const distanceX = lastOffset.x / lastTimeDiff;
                const distanceY = lastOffset.y / lastTimeDiff;
                const absX = Math.abs(distanceX);
                const absY = Math.abs(distanceY);
                // Skip swipe if low distance
                if (Math.max(absX, absY) < MIN_SWIPE_DISTANCE) {
                    return;
                }
                let currentX = distanceX;
                let currentY = distanceY;
                this.motion = window.setInterval(() => {
                    if (Math.abs(currentX) < STOP_SWIPE_DISTANCE && Math.abs(currentY) < STOP_SWIPE_DISTANCE) {
                        window.clearInterval(this.motion);
                        return;
                    }
                    currentX *= SPEED_OFF_MULTIPLE;
                    currentY *= SPEED_OFF_MULTIPLE;
                    this.onOffset(currentX * REFRESH_INTERVAL, currentY * REFRESH_INTERVAL, e);
                }, REFRESH_INTERVAL);
            }
        };
        this.onTouchMove = (e) => {
            if (!this.touchPosition) {
                return;
            }
            e.preventDefault();
            const { screenX, screenY } = e.touches[0];
            const offsetX = screenX - this.touchPosition.x;
            const offsetY = screenY - this.touchPosition.y;
            this.onOffset(offsetX, offsetY, e);
            const now = Date.now();
            this.lastTimeDiff = now - this.lastTimestamp;
            this.lastTimestamp = now;
            this.lastOffset = { x: offsetX, y: offsetY };
            this.touchPosition = { x: screenX, y: screenY };
        };
        this.onTouchStart = (e) => {
            const { screenX, screenY } = e.touches[0];
            this.touchPosition = { x: screenX, y: screenY };
            window.clearInterval(this.motion);
        };
        this.onWheel = (e) => {
            const { deltaX, deltaY } = e;
            let mixed;
            const absX = Math.abs(deltaX);
            const absY = Math.abs(deltaY);
            if (absX === absY) {
                mixed = this.lastWheelDirection === 'x' ? deltaX : deltaY;
            }
            else if (absX > absY) {
                mixed = deltaX;
                this.lastWheelDirection = 'x';
            }
            else {
                mixed = deltaY;
                this.lastWheelDirection = 'y';
            }
            // Optimize mac touch scroll
            const now = Date.now();
            const absMixed = Math.abs(mixed);
            if (now - this.lastWheelTimestamp > 100 || absMixed - this.lastMixedWheel > 10) {
                this.lastWheelPrevent = false;
            }
            this.onOffset(-mixed, -mixed, e);
            if (e.defaultPrevented || this.lastWheelPrevent) {
                this.lastWheelPrevent = true;
            }
            this.lastWheelTimestamp = now;
            this.lastMixedWheel = absMixed;
        };
    }
    ngOnInit() {
        this.unsubscribe = this.ngZone.runOutsideAngular(() => {
            const el = this.elementRef.nativeElement;
            const wheel$ = fromEvent(el, 'wheel');
            const touchstart$ = fromEvent(el, 'touchstart');
            const touchmove$ = fromEvent(el, 'touchmove');
            const touchend$ = fromEvent(el, 'touchend');
            const subscription = new Subscription();
            subscription.add(this.subscribeWrap('wheel', wheel$, this.onWheel));
            subscription.add(this.subscribeWrap('touchstart', touchstart$, this.onTouchStart));
            subscription.add(this.subscribeWrap('touchmove', touchmove$, this.onTouchMove));
            subscription.add(this.subscribeWrap('touchend', touchend$, this.onTouchEnd));
            return () => {
                subscription.unsubscribe();
            };
        });
    }
    subscribeWrap(type, observable, handler) {
        return observable.subscribe(event => {
            this.tabScroll.emit({
                type,
                event
            });
            if (!event.defaultPrevented) {
                handler(event);
            }
        });
    }
    onOffset(x, y, event) {
        this.ngZone.run(() => {
            this.offsetChange.emit({
                x,
                y,
                event
            });
        });
    }
    ngOnDestroy() {
        this.unsubscribe();
    }
}
NzTabScrollListDirective.ɵfac = function NzTabScrollListDirective_Factory(t) { return new (t || NzTabScrollListDirective)(ɵngcc0.ɵɵdirectiveInject(ɵngcc0.NgZone), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ElementRef)); };
NzTabScrollListDirective.ɵdir = ɵngcc0.ɵɵdefineDirective({ type: NzTabScrollListDirective, selectors: [["", "nzTabScrollList", ""]], outputs: { offsetChange: "offsetChange", tabScroll: "tabScroll" } });
NzTabScrollListDirective.ctorParameters = () => [
    { type: NgZone },
    { type: ElementRef }
];
NzTabScrollListDirective.propDecorators = {
    offsetChange: [{ type: Output }],
    tabScroll: [{ type: Output }]
};
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(NzTabScrollListDirective, [{
        type: Directive,
        args: [{
                selector: '[nzTabScrollList]'
            }]
    }], function () { return [{ type: ɵngcc0.NgZone }, { type: ɵngcc0.ElementRef }]; }, { offsetChange: [{
            type: Output
        }], tabScroll: [{
            type: Output
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFiLXNjcm9sbC1saXN0LmRpcmVjdGl2ZS5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vY29tcG9uZW50cy90YWJzL3RhYi1zY3JvbGwtbGlzdC5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUVILE9BQU8sRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBRSxNQUFNLEVBQXFCLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUV2RyxPQUFPLEVBQUUsU0FBUyxFQUFjLFlBQVksRUFBRSxNQUFNLE1BQU0sQ0FBQzs7QUFJM0QsTUFBTSxrQkFBa0IsR0FBRyxHQUFHLENBQUM7QUFDL0IsTUFBTSxtQkFBbUIsR0FBRyxJQUFJLENBQUM7QUFDakMsTUFBTSxnQkFBZ0IsR0FBRyxFQUFFLENBQUM7QUFDNUIsTUFBTSxrQkFBa0IsR0FBRyxTQUFBLEtBQUssRUFBSSxnQkFBZ0IsQ0FBQSxDQUFDO0FBS3JELE1BQU0sT0FBTyx3QkFBd0I7QUFBRyxJQWdCdEMsWUFBb0IsTUFBYyxFQUFVLFVBQW1DO0FBQUksUUFBL0QsV0FBTSxHQUFOLE1BQU0sQ0FBUTtBQUFDLFFBQVMsZUFBVSxHQUFWLFVBQVUsQ0FBeUI7QUFBQyxRQWZoRix1QkFBa0IsR0FBcUIsSUFBSSxDQUFDO0FBQzlDLFFBQUUsdUJBQWtCLEdBQUcsQ0FBQyxDQUFDO0FBQ3pCLFFBQUUsa0JBQWEsR0FBRyxDQUFDLENBQUM7QUFDcEIsUUFBRSxpQkFBWSxHQUFHLENBQUMsQ0FBQztBQUNuQixRQUFFLG1CQUFjLEdBQUcsQ0FBQyxDQUFDO0FBQ3JCLFFBQUUscUJBQWdCLEdBQUcsS0FBSyxDQUFDO0FBQzNCLFFBQUUsa0JBQWEsR0FBaUMsSUFBSSxDQUFDO0FBQ3JELFFBQUUsZUFBVSxHQUFpQyxJQUFJLENBQUM7QUFDbEQsUUFBRSxXQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7QUFDZCxRQUNFLGdCQUFXLEdBQWUsR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDekMsUUFDcUIsaUJBQVksR0FBRyxJQUFJLFlBQVksRUFBOEIsQ0FBQztBQUNuRixRQUFxQixjQUFTLEdBQUcsSUFBSSxZQUFZLEVBQW9CLENBQUM7QUFDdEUsUUF3Q0UsZUFBVSxHQUFHLENBQUMsQ0FBYSxFQUFRLEVBQUU7QUFDdkMsWUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRTtBQUM3QixnQkFBTSxPQUFPO0FBQ2IsYUFBSztBQUNMLFlBQUksTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQztBQUN2QyxZQUFJLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUM7QUFDM0MsWUFDSSxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDO0FBQ2hELFlBQ0ksSUFBSSxVQUFVLEVBQUU7QUFDcEIsZ0JBQU0sTUFBTSxTQUFTLEdBQUcsVUFBVSxDQUFDLENBQUMsR0FBRyxZQUFZLENBQUM7QUFDcEQsZ0JBQU0sTUFBTSxTQUFTLEdBQUcsVUFBVSxDQUFDLENBQUMsR0FBRyxZQUFZLENBQUM7QUFDcEQsZ0JBQU0sTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUN2QyxnQkFBTSxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ3ZDLGdCQUNNLDZCQUE2QjtBQUNuQyxnQkFBTSxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxHQUFHLGtCQUFrQixFQUFFO0FBQ3JELG9CQUFRLE9BQU87QUFDZixpQkFBTztBQUNQLGdCQUNNLElBQUksUUFBUSxHQUFHLFNBQVMsQ0FBQztBQUMvQixnQkFBTSxJQUFJLFFBQVEsR0FBRyxTQUFTLENBQUM7QUFDL0IsZ0JBQ00sSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUMsV0FBVyxDQUFDLEdBQUcsRUFBRTtBQUM1QyxvQkFBUSxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLEdBQUcsbUJBQW1CLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsR0FBRyxtQkFBbUIsRUFBRTtBQUNsRyx3QkFBVSxNQUFNLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUM1Qyx3QkFBVSxPQUFPO0FBQ2pCLHFCQUFTO0FBQ1Qsb0JBQ1EsUUFBUSxJQUFJLGtCQUFrQixDQUFDO0FBQ3ZDLG9CQUFRLFFBQVEsSUFBSSxrQkFBa0IsQ0FBQztBQUN2QyxvQkFBUSxJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsR0FBRyxnQkFBZ0IsRUFBRSxRQUFRLEdBQUcsZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDLENBQUM7QUFDbkYsZ0JBQU0sQ0FBQyxFQUFFLGdCQUFnQixDQUFDLENBQUM7QUFDM0IsYUFBSztBQUNMLFFBQUUsQ0FBQyxDQUFDO0FBQ0osUUFDRSxnQkFBVyxHQUFHLENBQUMsQ0FBYSxFQUFRLEVBQUU7QUFDeEMsWUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRTtBQUM3QixnQkFBTSxPQUFPO0FBQ2IsYUFBSztBQUNMLFlBQ0ksQ0FBQyxDQUFDLGNBQWMsRUFBRSxDQUFDO0FBQ3ZCLFlBQUksTUFBTSxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzlDLFlBQ0ksTUFBTSxPQUFPLEdBQUcsT0FBTyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO0FBQ25ELFlBQUksTUFBTSxPQUFPLEdBQUcsT0FBTyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO0FBQ25ELFlBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDO0FBQ3ZDLFlBQUksTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO0FBQzNCLFlBQ0ksSUFBSSxDQUFDLFlBQVksR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQztBQUNqRCxZQUFJLElBQUksQ0FBQyxhQUFhLEdBQUcsR0FBRyxDQUFDO0FBQzdCLFlBQUksSUFBSSxDQUFDLFVBQVUsR0FBRyxFQUFFLENBQUMsRUFBRSxPQUFPLEVBQUUsQ0FBQyxFQUFFLE9BQU8sRUFBRSxDQUFDO0FBQ2pELFlBQUksSUFBSSxDQUFDLGFBQWEsR0FBRyxFQUFFLENBQUMsRUFBRSxPQUFPLEVBQUUsQ0FBQyxFQUFFLE9BQU8sRUFBRSxDQUFDO0FBQ3BELFFBQUUsQ0FBQyxDQUFDO0FBQ0osUUFDRSxpQkFBWSxHQUFHLENBQUMsQ0FBYSxFQUFRLEVBQUU7QUFDekMsWUFBSSxNQUFNLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDOUMsWUFBSSxJQUFJLENBQUMsYUFBYSxHQUFHLEVBQUUsQ0FBQyxFQUFFLE9BQU8sRUFBRSxDQUFDLEVBQUUsT0FBTyxFQUFFLENBQUM7QUFDcEQsWUFBSSxNQUFNLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUN0QyxRQUFFLENBQUMsQ0FBQztBQUNKLFFBQ0UsWUFBTyxHQUFHLENBQUMsQ0FBYSxFQUFRLEVBQUU7QUFDcEMsWUFBSSxNQUFNLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQztBQUNqQyxZQUFJLElBQUksS0FBYSxDQUFDO0FBQ3RCLFlBQUksTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUNsQyxZQUFJLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDbEMsWUFDSSxJQUFJLElBQUksS0FBSyxJQUFJLEVBQUU7QUFDdkIsZ0JBQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxrQkFBa0IsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO0FBQ2hFLGFBQUs7QUFBQyxpQkFBSyxJQUFJLElBQUksR0FBRyxJQUFJLEVBQUU7QUFDNUIsZ0JBQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQztBQUNyQixnQkFBTSxJQUFJLENBQUMsa0JBQWtCLEdBQUcsR0FBRyxDQUFDO0FBQ3BDLGFBQUs7QUFBQyxpQkFBSztBQUNYLGdCQUFNLEtBQUssR0FBRyxNQUFNLENBQUM7QUFDckIsZ0JBQU0sSUFBSSxDQUFDLGtCQUFrQixHQUFHLEdBQUcsQ0FBQztBQUNwQyxhQUFLO0FBQ0wsWUFDSSw0QkFBNEI7QUFDaEMsWUFBSSxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7QUFDM0IsWUFBSSxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQ3JDLFlBQ0ksSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixHQUFHLEdBQUcsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLGNBQWMsR0FBRyxFQUFFLEVBQUU7QUFDcEYsZ0JBQU0sSUFBSSxDQUFDLGdCQUFnQixHQUFHLEtBQUssQ0FBQztBQUNwQyxhQUFLO0FBQ0wsWUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsS0FBSyxFQUFFLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO0FBQ3JDLFlBQUksSUFBSSxDQUFDLENBQUMsZ0JBQWdCLElBQUksSUFBSSxDQUFDLGdCQUFnQixFQUFFO0FBQ3JELGdCQUFNLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUM7QUFDbkMsYUFBSztBQUNMLFlBQ0ksSUFBSSxDQUFDLGtCQUFrQixHQUFHLEdBQUcsQ0FBQztBQUNsQyxZQUFJLElBQUksQ0FBQyxjQUFjLEdBQUcsUUFBUSxDQUFDO0FBQ25DLFFBQUUsQ0FBQyxDQUFDO0FBQ0osSUFuSW9GLENBQUM7QUFDckYsSUFDRSxRQUFRO0FBQUssUUFDWCxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsaUJBQWlCLENBQUMsR0FBRyxFQUFFO0FBQzFELFlBQU0sTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUM7QUFDL0MsWUFDTSxNQUFNLE1BQU0sR0FBRyxTQUFTLENBQWEsRUFBRSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0FBQ3hELFlBQU0sTUFBTSxXQUFXLEdBQUcsU0FBUyxDQUFhLEVBQUUsRUFBRSxZQUFZLENBQUMsQ0FBQztBQUNsRSxZQUFNLE1BQU0sVUFBVSxHQUFHLFNBQVMsQ0FBYSxFQUFFLEVBQUUsV0FBVyxDQUFDLENBQUM7QUFDaEUsWUFBTSxNQUFNLFNBQVMsR0FBRyxTQUFTLENBQWEsRUFBRSxFQUFFLFVBQVUsQ0FBQyxDQUFDO0FBQzlELFlBQ00sTUFBTSxZQUFZLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztBQUM5QyxZQUFNLFlBQVksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO0FBQzFFLFlBQU0sWUFBWSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLFlBQVksRUFBRSxXQUFXLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7QUFDekYsWUFBTSxZQUFZLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsV0FBVyxFQUFFLFVBQVUsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQztBQUN0RixZQUFNLFlBQVksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLEVBQUUsU0FBUyxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO0FBQ25GLFlBQ00sT0FBTyxHQUFHLEVBQUU7QUFDbEIsZ0JBQVEsWUFBWSxDQUFDLFdBQVcsRUFBRSxDQUFDO0FBQ25DLFlBQU0sQ0FBQyxDQUFDO0FBQ1IsUUFBSSxDQUFDLENBQUMsQ0FBQztBQUNQLElBQUUsQ0FBQztBQUNILElBQ0UsYUFBYSxDQUNYLElBQThCLEVBQzlCLFVBQXlCLEVBQ3pCLE9BQXNDO0FBQ3ZDLFFBQ0MsT0FBTyxVQUFVLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxFQUFFO0FBQ3hDLFlBQU0sSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUM7QUFDMUIsZ0JBQVEsSUFBSTtBQUNaLGdCQUFRLEtBQUs7QUFDYixhQUEyQixDQUFDLENBQUM7QUFDN0IsWUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLGdCQUFnQixFQUFFO0FBQ25DLGdCQUFRLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUN2QixhQUFPO0FBQ1AsUUFBSSxDQUFDLENBQUMsQ0FBQztBQUNQLElBQUUsQ0FBQztBQUNILElBOEZFLFFBQVEsQ0FBQyxDQUFTLEVBQUUsQ0FBUyxFQUFFLEtBQVk7QUFBSSxRQUM3QyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUU7QUFDekIsWUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQztBQUM3QixnQkFBUSxDQUFDO0FBQ1QsZ0JBQVEsQ0FBQztBQUNULGdCQUFRLEtBQUs7QUFDYixhQUFPLENBQUMsQ0FBQztBQUNULFFBQUksQ0FBQyxDQUFDLENBQUM7QUFDUCxJQUFFLENBQUM7QUFDSCxJQUNFLFdBQVc7QUFBSyxRQUNkLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztBQUN2QixJQUFFLENBQUM7QUFDSDtvREFwS0MsU0FBUyxTQUFDLGtCQUNULFFBQVEsRUFBRSxtQkFBbUIsY0FDOUI7ME1BQ0k7QUFBQztBQUFrRCxZQWRWLE1BQU07QUFBSSxZQUFwQyxVQUFVO0FBQUc7QUFBRztBQUE0QywyQkEyQjdFLE1BQU07QUFBSyx3QkFDWCxNQUFNO0FBQUk7Ozs7Ozs7Ozs7b0JBQUU7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9naXRodWIuY29tL05HLVpPUlJPL25nLXpvcnJvLWFudGQvYmxvYi9tYXN0ZXIvTElDRU5TRVxuICovXG5cbmltcG9ydCB7IERpcmVjdGl2ZSwgRWxlbWVudFJlZiwgRXZlbnRFbWl0dGVyLCBOZ1pvbmUsIE9uRGVzdHJveSwgT25Jbml0LCBPdXRwdXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgZnJvbUV2ZW50LCBPYnNlcnZhYmxlLCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHsgTnpUYWJTY3JvbGxFdmVudCwgTnpUYWJTY3JvbGxFdmVudEhhbmRsZXJGdW4sIE56VGFiU2Nyb2xsTGlzdE9mZnNldCwgTnpUYWJTY3JvbGxMaXN0T2Zmc2V0RXZlbnQgfSBmcm9tICcuL2ludGVyZmFjZXMnO1xuXG5jb25zdCBNSU5fU1dJUEVfRElTVEFOQ0UgPSAwLjE7XG5jb25zdCBTVE9QX1NXSVBFX0RJU1RBTkNFID0gMC4wMTtcbmNvbnN0IFJFRlJFU0hfSU5URVJWQUwgPSAyMDtcbmNvbnN0IFNQRUVEX09GRl9NVUxUSVBMRSA9IDAuOTk1ICoqIFJFRlJFU0hfSU5URVJWQUw7XG5cbkBEaXJlY3RpdmUoe1xuICBzZWxlY3RvcjogJ1tuelRhYlNjcm9sbExpc3RdJ1xufSlcbmV4cG9ydCBjbGFzcyBOelRhYlNjcm9sbExpc3REaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSB7XG4gIGxhc3RXaGVlbERpcmVjdGlvbjogJ3gnIHwgJ3knIHwgbnVsbCA9IG51bGw7XG4gIGxhc3RXaGVlbFRpbWVzdGFtcCA9IDA7XG4gIGxhc3RUaW1lc3RhbXAgPSAwO1xuICBsYXN0VGltZURpZmYgPSAwO1xuICBsYXN0TWl4ZWRXaGVlbCA9IDA7XG4gIGxhc3RXaGVlbFByZXZlbnQgPSBmYWxzZTtcbiAgdG91Y2hQb3NpdGlvbjogTnpUYWJTY3JvbGxMaXN0T2Zmc2V0IHwgbnVsbCA9IG51bGw7XG4gIGxhc3RPZmZzZXQ6IE56VGFiU2Nyb2xsTGlzdE9mZnNldCB8IG51bGwgPSBudWxsO1xuICBtb3Rpb24gPSAtMTtcblxuICB1bnN1YnNjcmliZTogKCkgPT4gdm9pZCA9ICgpID0+IHZvaWQgMDtcblxuICBAT3V0cHV0KCkgcmVhZG9ubHkgb2Zmc2V0Q2hhbmdlID0gbmV3IEV2ZW50RW1pdHRlcjxOelRhYlNjcm9sbExpc3RPZmZzZXRFdmVudD4oKTtcbiAgQE91dHB1dCgpIHJlYWRvbmx5IHRhYlNjcm9sbCA9IG5ldyBFdmVudEVtaXR0ZXI8TnpUYWJTY3JvbGxFdmVudD4oKTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIG5nWm9uZTogTmdab25lLCBwcml2YXRlIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWY8SFRNTEVsZW1lbnQ+KSB7fVxuXG4gIG5nT25Jbml0KCk6IHZvaWQge1xuICAgIHRoaXMudW5zdWJzY3JpYmUgPSB0aGlzLm5nWm9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XG4gICAgICBjb25zdCBlbCA9IHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50O1xuXG4gICAgICBjb25zdCB3aGVlbCQgPSBmcm9tRXZlbnQ8V2hlZWxFdmVudD4oZWwsICd3aGVlbCcpO1xuICAgICAgY29uc3QgdG91Y2hzdGFydCQgPSBmcm9tRXZlbnQ8VG91Y2hFdmVudD4oZWwsICd0b3VjaHN0YXJ0Jyk7XG4gICAgICBjb25zdCB0b3VjaG1vdmUkID0gZnJvbUV2ZW50PFRvdWNoRXZlbnQ+KGVsLCAndG91Y2htb3ZlJyk7XG4gICAgICBjb25zdCB0b3VjaGVuZCQgPSBmcm9tRXZlbnQ8VG91Y2hFdmVudD4oZWwsICd0b3VjaGVuZCcpO1xuXG4gICAgICBjb25zdCBzdWJzY3JpcHRpb24gPSBuZXcgU3Vic2NyaXB0aW9uKCk7XG4gICAgICBzdWJzY3JpcHRpb24uYWRkKHRoaXMuc3Vic2NyaWJlV3JhcCgnd2hlZWwnLCB3aGVlbCQsIHRoaXMub25XaGVlbCkpO1xuICAgICAgc3Vic2NyaXB0aW9uLmFkZCh0aGlzLnN1YnNjcmliZVdyYXAoJ3RvdWNoc3RhcnQnLCB0b3VjaHN0YXJ0JCwgdGhpcy5vblRvdWNoU3RhcnQpKTtcbiAgICAgIHN1YnNjcmlwdGlvbi5hZGQodGhpcy5zdWJzY3JpYmVXcmFwKCd0b3VjaG1vdmUnLCB0b3VjaG1vdmUkLCB0aGlzLm9uVG91Y2hNb3ZlKSk7XG4gICAgICBzdWJzY3JpcHRpb24uYWRkKHRoaXMuc3Vic2NyaWJlV3JhcCgndG91Y2hlbmQnLCB0b3VjaGVuZCQsIHRoaXMub25Ub3VjaEVuZCkpO1xuXG4gICAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgICBzdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICAgIH07XG4gICAgfSk7XG4gIH1cblxuICBzdWJzY3JpYmVXcmFwPFQgZXh0ZW5kcyBOelRhYlNjcm9sbEV2ZW50WydldmVudCddPihcbiAgICB0eXBlOiBOelRhYlNjcm9sbEV2ZW50Wyd0eXBlJ10sXG4gICAgb2JzZXJ2YWJsZTogT2JzZXJ2YWJsZTxUPixcbiAgICBoYW5kbGVyOiBOelRhYlNjcm9sbEV2ZW50SGFuZGxlckZ1bjxUPlxuICApOiBTdWJzY3JpcHRpb24ge1xuICAgIHJldHVybiBvYnNlcnZhYmxlLnN1YnNjcmliZShldmVudCA9PiB7XG4gICAgICB0aGlzLnRhYlNjcm9sbC5lbWl0KHtcbiAgICAgICAgdHlwZSxcbiAgICAgICAgZXZlbnRcbiAgICAgIH0gYXMgTnpUYWJTY3JvbGxFdmVudCk7XG4gICAgICBpZiAoIWV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQpIHtcbiAgICAgICAgaGFuZGxlcihldmVudCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBvblRvdWNoRW5kID0gKGU6IFRvdWNoRXZlbnQpOiB2b2lkID0+IHtcbiAgICBpZiAoIXRoaXMudG91Y2hQb3NpdGlvbikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBsYXN0T2Zmc2V0ID0gdGhpcy5sYXN0T2Zmc2V0O1xuICAgIGNvbnN0IGxhc3RUaW1lRGlmZiA9IHRoaXMubGFzdFRpbWVEaWZmO1xuXG4gICAgdGhpcy5sYXN0T2Zmc2V0ID0gdGhpcy50b3VjaFBvc2l0aW9uID0gbnVsbDtcblxuICAgIGlmIChsYXN0T2Zmc2V0KSB7XG4gICAgICBjb25zdCBkaXN0YW5jZVggPSBsYXN0T2Zmc2V0LnggLyBsYXN0VGltZURpZmY7XG4gICAgICBjb25zdCBkaXN0YW5jZVkgPSBsYXN0T2Zmc2V0LnkgLyBsYXN0VGltZURpZmY7XG4gICAgICBjb25zdCBhYnNYID0gTWF0aC5hYnMoZGlzdGFuY2VYKTtcbiAgICAgIGNvbnN0IGFic1kgPSBNYXRoLmFicyhkaXN0YW5jZVkpO1xuXG4gICAgICAvLyBTa2lwIHN3aXBlIGlmIGxvdyBkaXN0YW5jZVxuICAgICAgaWYgKE1hdGgubWF4KGFic1gsIGFic1kpIDwgTUlOX1NXSVBFX0RJU1RBTkNFKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgbGV0IGN1cnJlbnRYID0gZGlzdGFuY2VYO1xuICAgICAgbGV0IGN1cnJlbnRZID0gZGlzdGFuY2VZO1xuXG4gICAgICB0aGlzLm1vdGlvbiA9IHdpbmRvdy5zZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICAgIGlmIChNYXRoLmFicyhjdXJyZW50WCkgPCBTVE9QX1NXSVBFX0RJU1RBTkNFICYmIE1hdGguYWJzKGN1cnJlbnRZKSA8IFNUT1BfU1dJUEVfRElTVEFOQ0UpIHtcbiAgICAgICAgICB3aW5kb3cuY2xlYXJJbnRlcnZhbCh0aGlzLm1vdGlvbik7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY3VycmVudFggKj0gU1BFRURfT0ZGX01VTFRJUExFO1xuICAgICAgICBjdXJyZW50WSAqPSBTUEVFRF9PRkZfTVVMVElQTEU7XG4gICAgICAgIHRoaXMub25PZmZzZXQoY3VycmVudFggKiBSRUZSRVNIX0lOVEVSVkFMLCBjdXJyZW50WSAqIFJFRlJFU0hfSU5URVJWQUwsIGUpO1xuICAgICAgfSwgUkVGUkVTSF9JTlRFUlZBTCk7XG4gICAgfVxuICB9O1xuXG4gIG9uVG91Y2hNb3ZlID0gKGU6IFRvdWNoRXZlbnQpOiB2b2lkID0+IHtcbiAgICBpZiAoIXRoaXMudG91Y2hQb3NpdGlvbikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICBjb25zdCB7IHNjcmVlblgsIHNjcmVlblkgfSA9IGUudG91Y2hlc1swXTtcblxuICAgIGNvbnN0IG9mZnNldFggPSBzY3JlZW5YIC0gdGhpcy50b3VjaFBvc2l0aW9uLng7XG4gICAgY29uc3Qgb2Zmc2V0WSA9IHNjcmVlblkgLSB0aGlzLnRvdWNoUG9zaXRpb24ueTtcbiAgICB0aGlzLm9uT2Zmc2V0KG9mZnNldFgsIG9mZnNldFksIGUpO1xuICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG5cbiAgICB0aGlzLmxhc3RUaW1lRGlmZiA9IG5vdyAtIHRoaXMubGFzdFRpbWVzdGFtcDtcbiAgICB0aGlzLmxhc3RUaW1lc3RhbXAgPSBub3c7XG4gICAgdGhpcy5sYXN0T2Zmc2V0ID0geyB4OiBvZmZzZXRYLCB5OiBvZmZzZXRZIH07XG4gICAgdGhpcy50b3VjaFBvc2l0aW9uID0geyB4OiBzY3JlZW5YLCB5OiBzY3JlZW5ZIH07XG4gIH07XG5cbiAgb25Ub3VjaFN0YXJ0ID0gKGU6IFRvdWNoRXZlbnQpOiB2b2lkID0+IHtcbiAgICBjb25zdCB7IHNjcmVlblgsIHNjcmVlblkgfSA9IGUudG91Y2hlc1swXTtcbiAgICB0aGlzLnRvdWNoUG9zaXRpb24gPSB7IHg6IHNjcmVlblgsIHk6IHNjcmVlblkgfTtcbiAgICB3aW5kb3cuY2xlYXJJbnRlcnZhbCh0aGlzLm1vdGlvbik7XG4gIH07XG5cbiAgb25XaGVlbCA9IChlOiBXaGVlbEV2ZW50KTogdm9pZCA9PiB7XG4gICAgY29uc3QgeyBkZWx0YVgsIGRlbHRhWSB9ID0gZTtcbiAgICBsZXQgbWl4ZWQ6IG51bWJlcjtcbiAgICBjb25zdCBhYnNYID0gTWF0aC5hYnMoZGVsdGFYKTtcbiAgICBjb25zdCBhYnNZID0gTWF0aC5hYnMoZGVsdGFZKTtcblxuICAgIGlmIChhYnNYID09PSBhYnNZKSB7XG4gICAgICBtaXhlZCA9IHRoaXMubGFzdFdoZWVsRGlyZWN0aW9uID09PSAneCcgPyBkZWx0YVggOiBkZWx0YVk7XG4gICAgfSBlbHNlIGlmIChhYnNYID4gYWJzWSkge1xuICAgICAgbWl4ZWQgPSBkZWx0YVg7XG4gICAgICB0aGlzLmxhc3RXaGVlbERpcmVjdGlvbiA9ICd4JztcbiAgICB9IGVsc2Uge1xuICAgICAgbWl4ZWQgPSBkZWx0YVk7XG4gICAgICB0aGlzLmxhc3RXaGVlbERpcmVjdGlvbiA9ICd5JztcbiAgICB9XG5cbiAgICAvLyBPcHRpbWl6ZSBtYWMgdG91Y2ggc2Nyb2xsXG4gICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICBjb25zdCBhYnNNaXhlZCA9IE1hdGguYWJzKG1peGVkKTtcblxuICAgIGlmIChub3cgLSB0aGlzLmxhc3RXaGVlbFRpbWVzdGFtcCA+IDEwMCB8fCBhYnNNaXhlZCAtIHRoaXMubGFzdE1peGVkV2hlZWwgPiAxMCkge1xuICAgICAgdGhpcy5sYXN0V2hlZWxQcmV2ZW50ID0gZmFsc2U7XG4gICAgfVxuICAgIHRoaXMub25PZmZzZXQoLW1peGVkLCAtbWl4ZWQsIGUpO1xuICAgIGlmIChlLmRlZmF1bHRQcmV2ZW50ZWQgfHwgdGhpcy5sYXN0V2hlZWxQcmV2ZW50KSB7XG4gICAgICB0aGlzLmxhc3RXaGVlbFByZXZlbnQgPSB0cnVlO1xuICAgIH1cblxuICAgIHRoaXMubGFzdFdoZWVsVGltZXN0YW1wID0gbm93O1xuICAgIHRoaXMubGFzdE1peGVkV2hlZWwgPSBhYnNNaXhlZDtcbiAgfTtcblxuICBvbk9mZnNldCh4OiBudW1iZXIsIHk6IG51bWJlciwgZXZlbnQ6IEV2ZW50KTogdm9pZCB7XG4gICAgdGhpcy5uZ1pvbmUucnVuKCgpID0+IHtcbiAgICAgIHRoaXMub2Zmc2V0Q2hhbmdlLmVtaXQoe1xuICAgICAgICB4LFxuICAgICAgICB5LFxuICAgICAgICBldmVudFxuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLnVuc3Vic2NyaWJlKCk7XG4gIH1cbn1cbiJdfQ==